# YOLOv3 ğŸš€ by Ultralytics, GPL-3.0 license


# depth_multipleï¼šè¡¨ç¤ºConvæ¨¡å—çš„ç¼©æ”¾å› å­ï¼Œå°†æ‰€æœ‰å—çš„ä¹˜ä¸Šè¯¥å‚æ•°å¾—åˆ°æœ€ç»ˆä¸ªæ•°ã€‚
# width_multipleï¼šè¡¨ç¤ºå·ç§¯é€šé“çš„ç¼©æ”¾å› å­ï¼Œå°±æ˜¯å°†é…ç½®é‡Œé¢çš„backboneå’Œheadéƒ¨åˆ†æœ‰å…³Convé€šé“çš„è®¾ç½®ï¼Œå…¨éƒ¨ä¹˜ä»¥è¯¥ç³»æ•°ã€‚
# é€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°å°±å¯ä»¥å®ç°ä¸åŒå¤æ‚åº¦çš„æ¨¡å‹è®¾è®¡ã€‚
# è¿™ä¸¤ä¸ªå‚æ•°æ˜¯Ultralyticså…¬å¸å‡ºå“çš„yolov5é‡Œé¢çš„å‚æ•°ï¼Œæˆ‘ä»¬è¿™ä¸ªyolov3ä¹ŸåŒæ ·æ˜¯Ultralyticså…¬å¸å‡ºå“çš„ï¼Œå› æ­¤æ²¿ç”¨äº†è¿™ä¸ªå‚æ•°ã€‚(åŸæœ¬Joseph Redmonæ˜¯æ²¡æœ‰è¿™ä¸ªå‚æ•°çš„)
# Parameters
nc: 20  # æ¨¡å‹è¯†åˆ«çš„ç±»åˆ«æ•°é‡
depth_multiple: 1.0  # æ¨¡å‹æ·±åº¦å‚æ•°
width_multiple: 1.0  # æ¨¡å‹é€šé“å‚æ•°


# yolov3åˆå§‹åŒ–äº†9ä¸ªanchorsï¼Œåœ¨ä¸‰ä¸ªDetectå±‚ä½¿ç”¨ï¼ˆ3ä¸ªfeature mapï¼‰ä¸­ä½¿ç”¨ï¼Œæ¯ä¸ªfeature mapçš„æ¯ä¸ªgrid_celléƒ½æœ‰ä¸‰ä¸ªanchorè¿›è¡Œé¢„æµ‹ã€‚
# yolov3æ ¹æ®k-meanså¾—åˆ°äº†è¿™ä¹ˆ3ç»„anchorsï¼Œå¯¹äºå¾ˆå¤šæ•°æ®é›†è€Œè¨€ç¡®å®æŒºåˆé€‚çš„ã€‚
# ä½†æ˜¯ä¹Ÿä¸èƒ½ä¿è¯è¿™3ç»„anchorså°±é€‚ç”¨äºæ‰€æœ‰çš„æ•°æ®é›†ã€‚
anchors:
  - [10,13, 16,30, 33,23]  # P3/8
  - [30,61, 62,45, 59,119]  # P4/16
  - [116,90, 156,198, 373,326]  # P5/32




# darknet53 backbone
backbone:
  # [from, number, module, args]
  # fromï¼šè¡¨ç¤ºå½“å‰æ¨¡å—çš„è¾“å…¥æ¥è‡ªé‚£ä¸€å±‚çš„è¾“å‡ºï¼Œ-1è¡¨ç¤ºæ¥è‡ªä¸Šä¸€å±‚çš„è¾“å‡ºã€‚
  # numberï¼šè¡¨ç¤ºæœ¬æ¨¡å—çš„ç†è®ºé‡å¤æ¬¡æ•°ï¼Œ1è¡¨ç¤ºåªæœ‰ä¸€ä¸ªï¼Œ3è¡¨ç¤ºé‡å¤3æ¬¡ã€‚å®é™…çš„é‡å¤æ¬¡æ•°:numberÃ—depth_multiple
  # moduleï¼šæ¨¡å—åï¼Œé€šè¿‡è¿™ä¸ªç±»åå»common.pyä¸­å¯»æ‰¾ç›¸åº”çš„ç±»ï¼Œè¿›è¡Œæ¨¡å—åŒ–çš„æ­å»ºç½‘ç»œã€‚
  # args: åœ¨ç½‘ç»œæ­å»ºè¿‡ç¨‹ä¸­æ ¹æ®ä¸åŒå±‚è¿›è¡Œæ”¹å˜ï¼Œæ˜¯æ¨¡å—æ­å»ºæ‰€éœ€å‚æ•°çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬channelï¼Œkernel_sizeï¼Œstrideï¼Œpaddingï¼Œbiasç­‰ã€‚
  [[-1, 1, Conv, [32, 3, 1]],  # 0
   [-1, 1, Conv, [64, 3, 2]],  # 1-P1/2
   [-1, 1, Bottleneck, [64]],
   [-1, 1, Conv, [128, 3, 2]],  # 3-P2/4
   [-1, 2, Bottleneck, [128]],
   [-1, 1, Conv, [256, 3, 2]],  # 5-P3/8
   [-1, 8, Bottleneck, [256]],
   [-1, 1, Conv, [512, 3, 2]],  # 7-P4/16
   [-1, 8, Bottleneck, [512]],
   [-1, 1, Conv, [1024, 3, 2]],  # 9-P5/32
   [-1, 4, Bottleneck, [1024]],  # 10
  ]

# YOLOv3 head
# head = PANet+Detect ä½œè€…æ²¡æœ‰åŒºåˆ†neckæ¨¡å—ï¼Œæ‰€ä»¥headéƒ¨åˆ†åŒ…å«äº†PANet+Detectéƒ¨åˆ†
# [from, number, module, args]
  # from: è¡¨ç¤ºå½“å‰æ¨¡å—çš„è¾“å…¥æ¥è‡ªé‚£ä¸€å±‚çš„è¾“å‡ºï¼Œ-1è¡¨ç¤ºæ¥è‡ªä¸Šä¸€å±‚çš„è¾“å‡ºã€‚ä¸è¿‡è¿™é‡Œå¯ä»¥ä¸ºlistï¼Œå°±æ˜¯è¿™å±‚çš„è¾“å…¥ç”±æ‰€å±‚è¾“å‡ºconcatè€Œæ¥ã€‚
  # numberï¼šè¡¨ç¤ºæœ¬æ¨¡å—çš„ç†è®ºé‡å¤æ¬¡æ•°ï¼Œ1è¡¨ç¤ºåªæœ‰ä¸€ä¸ªï¼Œ3è¡¨ç¤ºé‡å¤3æ¬¡ã€‚å®é™…çš„é‡å¤æ¬¡æ•°:numberÃ—depth_multiple
  # moduleï¼šæ¨¡å—ç±»åï¼Œé€šè¿‡è¿™ä¸ªç±»åå»common.pyä¸­å¯»æ‰¾ç›¸åº”çš„ç±»ï¼Œè¿›è¡Œæ¨¡å—åŒ–çš„æ­å»ºç½‘ç»œã€‚
  # argsï¼šæ˜¯ä¸€ä¸ªlistï¼Œæ˜¯æ¨¡å—æ­å»ºæ‰€éœ€å‚æ•°çš„åˆ—è¡¨ï¼ŒåŒ…æ‹¬channelï¼Œkernel_sizeï¼Œstrideï¼Œpaddingï¼Œbiasç­‰
head:
  [[-1, 1, Bottleneck, [1024, False]],
   [-1, 1, Conv, [512, [1, 1]]],
   [-1, 1, Conv, [1024, 3, 1]],
   [-1, 1, Conv, [512, 1, 1]],
   [-1, 1, Conv, [1024, 3, 1]],  # 15 (P5/32-large)

   [-2, 1, Conv, [256, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 8], 1, Concat, [1]],  # cat backbone P4
   [-1, 1, Bottleneck, [512, False]],
   [-1, 1, Bottleneck, [512, False]],
   [-1, 1, Conv, [256, 1, 1]],
   [-1, 1, Conv, [512, 3, 1]],  # 22 (P4/16-medium)

   [-2, 1, Conv, [128, 1, 1]],
   [-1, 1, nn.Upsample, [None, 2, 'nearest']],
   [[-1, 6], 1, Concat, [1]],  # cat backbone P3
   [-1, 1, Bottleneck, [256, False]],
   [-1, 2, Bottleneck, [256, False]],  # 27 (P3/8-small)

   [[27, 22, 15], 1, Detect, [nc, anchors]],   # Detect(P3, P4, P5)
  ]
